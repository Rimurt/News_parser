import os
from dotenv import load_dotenv
from openai import OpenAI
from db import session, News

load_dotenv()
token = os.getenv("HF_TOKEN")
if token is None:
    raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω HF –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è HF_TOKEN")

client = OpenAI(
    base_url="https://router.huggingface.co/v1",
    api_key=token,
)


def redacter():

    news = session.query(News).filter_by(content_is_redacted=False).all()

    if not news:
        return None

    for row in news:
        try:
            completion = client.chat.completions.create(
                model="moonshotai/Kimi-K2-Instruct:novita",
                messages=[
                    {
                        "role": "user",
                        "content": f'''–¢—ã ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä Telegram-–∫–∞–Ω–∞–ª–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ª—é–±—É—é –±–æ–ª—å—à—É—é –Ω–æ–≤–æ—Å—Ç–Ω—É—é —Å—Ç–∞—Ç—å—é –≤ –∫–æ—Ä–æ—Ç–∫–∏–π, —è—Ä–∫–∏–π –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç. –ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —Ü–µ–ø–ª—è—Ç—å —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –±—ã—Ç—å –ø—Ä–æ—Å—Ç—ã–º –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∏–Ω—Ç—Ä–∏–≥–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.

                –ü—Ä–∞–≤–∏–ª–∞:

                –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –ø–æ—Å—Ç. –ï–≥–æ –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –±–æ–ª–µ–µ —Ü–µ–ø–ª—è—é—â–∏–º –∏ –∏–Ω—Ç—Ä–∏–≥—É—é—â–∏–º, –Ω–æ —Å–º—ã—Å–ª –Ω–æ–≤–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.

                –≠–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ: –ø–æ–¥–±–∏—Ä–∞–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π —ç–º–æ–¥–∑–∏ –ø–æ–¥ —Ç–µ–º—É –Ω–æ–≤–æ—Å—Ç–∏. –ï—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –Ω–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π üíÆ.

                –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–±–∏–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ –±—É–ª–ª–µ—Ç—ã (‚ûñ –∏–ª–∏ ‚Ä¢), –∫–∞–∂–¥–∞—è –º—ã—Å–ª—å ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞.

                –°—Ç–∏–ª—å: —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –∂–∏–≤–æ–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ª—ë–≥–∫–∏–π —é–º–æ—Ä, –º–µ–º–Ω—ã–µ –∏–ª–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.

                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ, –ª–µ–≥–∫–æ —É—Å–≤–∞–∏–≤–∞–µ–º–æ–µ. –í–∫–ª—é—á–∞–π –¥–∞—Ç—ã, —Ü–∏—Ñ—Ä—ã, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, —Ä–µ–π—Ç–∏–Ω–≥–∏.

                –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç ‚Äî –∏–Ω—Ç—Ä–∏–≥–∞, —é–º–æ—Ä –∏–ª–∏ –≤—ã–∑–æ–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é.

                –Ø–∑—ã–∫: –ø—Ä–æ—Å—Ç–æ–π, –¥—Ä—É–∂–µ—Å–∫–∏–π, –∫–∞–∫ –±—É–¥—Ç–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –¥—Ä—É–∑—å—è–º.

                –§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

                [–≠–º–æ–¥–∑–∏] [–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å)]

                ‚Ä¢ [–°–∞–º—ã–π —è—Ä–∫–∏–π —Ñ–∞–∫—Ç 1; —Ü–∏—Ñ—Ä—ã, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –¥–∞—Ç–∞]
                ‚Ä¢ [–°–∞–º—ã–π —è—Ä–∫–∏–π —Ñ–∞–∫—Ç 2; —Ü–∏—Ñ—Ä—ã, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –¥–∞—Ç–∞]
                ‚Ä¢ [–°–∞–º—ã–π —è—Ä–∫–∏–π —Ñ–∞–∫—Ç 3‚Ä¶]
                ‚Ä¢ [–ó–∞–∫–ª—é—á–µ–Ω–∏–µ: –∏–Ω—Ç—Ä–∏–≥–∞, —é–º–æ—Ä, –≤—ã–∑–æ–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é]

                –ü—Ä–∏–º–µ—Ä:
                üéÆ Valve –ø–æ–∫–∞–∑–∞–ª–∞ –Ω–æ–≤—É—é –∫–æ–Ω—Å–æ–ª—å!

                ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ SteamOS, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 4–ö –∏ 60 FPS;
                ‚Ä¢ –†–∞–∑–º–µ—Ä ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π –∫—É–±–∏–∫ 16 —Å–º;
                ‚Ä¢ –î–≤–µ –º–æ–¥–µ–ª–∏ ‚Äî 512 –ì–ë –∏ 2 –¢–ë, —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ microSD;
                ‚Ä¢ –†–µ–ª–∏–∑ ‚Äî –Ω–∞—á–∞–ª–æ 2026 –≥–æ–¥–∞.

            –ó–∞–≥–æ–ª–æ–≤–æ–∫:
            {row.title}
                
            –°—Ç–∞—Ç—å—è:
            {row.content}
            '''
                    }
                ],) 

            row.post_content = completion.choices[0].message.content #type:ignore
            row.content_is_redacted = True #type:ignore
        except Exception:
            session.rollback()
            return Exception
        finally:
            print(f"–ü–æ—Å—Ç —Å id {row.id} –æ–±—Ä–∞–±–æ—Ç–∞–Ω")
            session.commit()
    return "corect"